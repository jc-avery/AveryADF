{
	"name": "PL_CH_DirectDebitData",
	"properties": {
		"activities": [
			{
				"name": "Copy Direct Debit to Stage",
				"type": "Copy",
				"dependsOn": [],
				"policy": {
					"timeout": "0.12:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"typeProperties": {
					"source": {
						"type": "SqlServerSource",
						"sqlReaderQuery": "SELECT\n\tDIRECTD_DT.DDDT_REF,\n\tDirectD_Hd.DDHD_REF,\n\tFundSrc_Hd.AccNo,\n    Resident.Res_Code,\n\tDirectD_DT.INVOICE_NO AS InvoiceNo,\n    DirectD_Dt.DDTranType AS DDTypeID,\n\tCASE \n\t\tWHEN DirectD_Dt.DDTranType = 1 THEN 'New DD'\n\t\tWHEN DirectD_Dt.DDTranType = 17 THEN 'Standard DD'\n\t\tWHEN DirectD_Dt.DDTranType = 18 THEN 'Cancel DD'\n\t\tWHEN DirectD_Dt.DDTranType = 19 THEN 'Change of value'\n\t\tELSE ''\n\tEND AS DDTranType,\n    DirectD_Dt.Amount AS DDAmount,\n    isnull(DirectD_Dt.Due_Date, DirectD_Dt.Inv_Date) AS DueDate,\n    DirectD_Dt.Submitted AS SubmittedDate,\n    DirectD_Dt.Allocated AS AllocationStatus,\n    DirectD_Hd.BatchNo,\n\tS.SITEID\nFROM \n\tDirectD_Dt (NOLOCK)\n    \n    JOIN DirectD_Hd (NOLOCK)\n        ON DirectD_Hd.DDHd_Ref = DirectD_Dt.DDHd_Ref\n\n    JOIN FundSrc_Hd (NOLOCK)\n\t\tON FundSrc_Hd.FS_Ref = DirectD_Dt.FS_Ref\n\n\tJOIN Resident (NOLOCK)\n\t\tON Resident.Res_Ref = FundSrc_Hd.Res_Ref\n\t\t\n\tJOIN Site AS S(NOLOCK)\n        ON S.Site_Ref = DIRECTD_HD.Site_Ref   ",
						"queryTimeout": "02:00:00",
						"partitionOption": "None"
					},
					"sink": {
						"type": "AzureSqlSink",
						"preCopyScript": "TRUNCATE TABLE ColdHarbour.STGDirectDebits",
						"writeBehavior": "insert",
						"sqlWriterUseTableLock": false,
						"disableMetricsCollection": false
					},
					"enableStaging": false,
					"translator": {
						"type": "TabularTranslator",
						"mappings": [
							{
								"source": {
									"name": "DDDT_REF",
									"type": "Int32",
									"physicalType": "int"
								},
								"sink": {
									"name": "DDDT_REF",
									"type": "Int32",
									"physicalType": "int"
								}
							},
							{
								"source": {
									"name": "DDHD_REF",
									"type": "Int32",
									"physicalType": "int"
								},
								"sink": {
									"name": "DDHD_REF",
									"type": "Int32",
									"physicalType": "int"
								}
							},
							{
								"source": {
									"name": "AccNo",
									"type": "String",
									"physicalType": "char"
								},
								"sink": {
									"name": "AccNo",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "Res_Code",
									"type": "String",
									"physicalType": "char"
								},
								"sink": {
									"name": "RES_CODE",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "InvoiceNo",
									"type": "String",
									"physicalType": "char"
								},
								"sink": {
									"name": "InvoiceNo",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "DDTypeID",
									"type": "String",
									"physicalType": "char"
								},
								"sink": {
									"name": "DDTypeID",
									"type": "Int32",
									"physicalType": "int"
								}
							},
							{
								"source": {
									"name": "DDTranType",
									"type": "String",
									"physicalType": "varchar"
								},
								"sink": {
									"name": "DDTranType",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "DDAmount",
									"type": "Decimal",
									"physicalType": "decimal",
									"scale": 9,
									"precision": 19
								},
								"sink": {
									"name": "DDAmount",
									"type": "Decimal",
									"physicalType": "decimal",
									"scale": 9,
									"precision": 19
								}
							},
							{
								"source": {
									"name": "DueDate",
									"type": "DateTime",
									"physicalType": "datetime"
								},
								"sink": {
									"name": "DueDate",
									"type": "DateTime",
									"physicalType": "date"
								}
							},
							{
								"source": {
									"name": "SubmittedDate",
									"type": "DateTime",
									"physicalType": "datetime"
								},
								"sink": {
									"name": "SubmittedDate",
									"type": "DateTime",
									"physicalType": "date"
								}
							},
							{
								"source": {
									"name": "AllocationStatus",
									"type": "String",
									"physicalType": "char"
								},
								"sink": {
									"name": "AllocationStatus",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "BatchNo",
									"type": "Int32",
									"physicalType": "int"
								},
								"sink": {
									"name": "BatchNo",
									"type": "Int32",
									"physicalType": "int"
								}
							},
							{
								"source": {
									"name": "SITEID",
									"type": "String",
									"physicalType": "char"
								},
								"sink": {
									"name": "SITEID",
									"type": "String",
									"physicalType": "varchar"
								}
							}
						],
						"typeConversion": true,
						"typeConversionSettings": {
							"allowDataTruncation": true,
							"treatBooleanAsNumber": false
						}
					}
				},
				"inputs": [
					{
						"referenceName": "DS_OnPrem_CH_IP",
						"type": "DatasetReference",
						"parameters": {
							"Schema": "n/a",
							"Table": "n/a"
						}
					}
				],
				"outputs": [
					{
						"referenceName": "DS_AH2_TRANSFORM_DB",
						"type": "DatasetReference",
						"parameters": {
							"Schema": "ColdHarbour",
							"Table": "STGDirectDebits"
						}
					}
				]
			},
			{
				"name": "Copy data",
				"type": "Copy",
				"dependsOn": [
					{
						"activity": "Copy Direct Debit to Stage",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"policy": {
					"timeout": "0.12:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"typeProperties": {
					"source": {
						"type": "AzureSqlSource",
						"sqlReaderQuery": "SELECT\n    DD.[SITEID]\n    ,H.HOME_REF\n    ,H.HomeName\n    ,DD.DDDT_REF\n    ,DD.[DDHD_REF]\n    ,DD.[AccNo]\n    ,DD.[RES_CODE]\n    ,DD.[InvoiceNo]\n    ,DD.[DDTypeID]\n    ,DD.[DDTranType]\n    ,DD.[DDAmount]\n    ,DD.[DueDate]\n    ,DD.[SubmittedDate]\n    ,DD.[AllocationStatus]\n    ,DD.[BatchNo]\nFROM \n    ColdHarbour.STGDirectDebits AS DD\n\n    LEFT JOIN GRG.HOME AS H\n        ON H.SiteID = DD.SiteID",
						"queryTimeout": "02:00:00",
						"partitionOption": "None"
					},
					"sink": {
						"type": "AzureSqlSink",
						"writeBehavior": "upsert",
						"upsertSettings": {
							"useTempDB": true,
							"keys": [
								"DDDT_REF"
							]
						},
						"sqlWriterUseTableLock": false,
						"disableMetricsCollection": false
					},
					"enableStaging": false,
					"translator": {
						"type": "TabularTranslator",
						"typeConversion": true,
						"typeConversionSettings": {
							"allowDataTruncation": true,
							"treatBooleanAsNumber": false
						}
					}
				},
				"inputs": [
					{
						"referenceName": "DS_AH2_TRANSFORM_DB",
						"type": "DatasetReference",
						"parameters": {
							"Schema": "n/a",
							"Table": "n/a"
						}
					}
				],
				"outputs": [
					{
						"referenceName": "DS_AH2_TRANSFORM_DB",
						"type": "DatasetReference",
						"parameters": {
							"Schema": "ColdHarbour",
							"Table": "DirectDebits"
						}
					}
				]
			},
			{
				"name": "Clear Stage Table",
				"type": "Script",
				"dependsOn": [
					{
						"activity": "Copy data",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"policy": {
					"timeout": "0.12:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"linkedServiceName": {
					"referenceName": "AH2_TRANSFORM_DB",
					"type": "LinkedServiceReference"
				},
				"typeProperties": {
					"scripts": [
						{
							"type": "Query",
							"text": "TRUNCATE TABLE ColdHarbour.STGDirectDebits"
						}
					],
					"scriptBlockExecutionTimeout": "02:00:00"
				}
			}
		],
		"folder": {
			"name": "Cold Harbour/Children Pipelines"
		},
		"annotations": []
	}
}