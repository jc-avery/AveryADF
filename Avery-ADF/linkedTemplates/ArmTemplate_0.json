{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"factoryName": {
			"type": "string",
			"metadata": "Data Factory name",
			"defaultValue": "Avery-ADF"
		},
		"AH1_Avery_connectionString": {
			"type": "secureString",
			"metadata": "Secure string for 'connectionString' of 'AH1_Avery'"
		},
		"AH2_Agency_password": {
			"type": "secureString",
			"metadata": "Secure string for 'password' of 'AH2_Agency'"
		},
		"AH2_Avery_connectionString": {
			"type": "secureString",
			"metadata": "Secure string for 'connectionString' of 'AH2_Avery'"
		},
		"AH2_Polestar_password": {
			"type": "secureString",
			"metadata": "Secure string for 'password' of 'AH2_Polestar'"
		},
		"AH2_TRANSFORM_DB_connectionString": {
			"type": "secureString",
			"metadata": "Secure string for 'connectionString' of 'AH2_TRANSFORM_DB'"
		},
		"AH2_YardiStage_password": {
			"type": "secureString",
			"metadata": "Secure string for 'password' of 'AH2_YardiStage'"
		},
		"AveryArtisan_Artisan_password": {
			"type": "secureString",
			"metadata": "Secure string for 'password' of 'AveryArtisan_Artisan'"
		},
		"CareBlox_FTP_password": {
			"type": "secureString",
			"metadata": "Secure string for 'password' of 'CareBlox_FTP'"
		},
		"Hydra_FTP_password": {
			"type": "secureString",
			"metadata": "Secure string for 'password' of 'Hydra_FTP'"
		},
		"PolestarStorageAcc_connectionString": {
			"type": "secureString",
			"metadata": "Secure string for 'connectionString' of 'PolestarStorageAcc'"
		},
		"PolestarStorageFileshare_connectionString": {
			"type": "secureString",
			"metadata": "Secure string for 'connectionString' of 'PolestarStorageFileshare'"
		},
		"Radar_DB_password": {
			"type": "secureString",
			"metadata": "Secure string for 'password' of 'Radar_DB'"
		},
		"Radar_FTP_password": {
			"type": "secureString",
			"metadata": "Secure string for 'password' of 'Radar_FTP'"
		},
		"Softworks_API_password": {
			"type": "secureString",
			"metadata": "Secure string for 'password' of 'Softworks_API'"
		},
		"AH2_Agency_properties_typeProperties_server": {
			"type": "string",
			"defaultValue": "averyhealthcare2.database.windows.net"
		},
		"AH2_Agency_properties_typeProperties_database": {
			"type": "string",
			"defaultValue": "Agency"
		},
		"AH2_Agency_properties_typeProperties_userName": {
			"type": "string",
			"defaultValue": "ADF_User"
		},
		"AH2_Polestar_properties_typeProperties_server": {
			"type": "string",
			"defaultValue": "averyhealthcare2.database.windows.net"
		},
		"AH2_Polestar_properties_typeProperties_database": {
			"type": "string",
			"defaultValue": "Polestar"
		},
		"AH2_Polestar_properties_typeProperties_userName": {
			"type": "string",
			"defaultValue": "ADF_User"
		},
		"AH2_YardiStage_properties_typeProperties_server": {
			"type": "string",
			"defaultValue": "averyhealthcare2.database.windows.net"
		},
		"AH2_YardiStage_properties_typeProperties_database": {
			"type": "string",
			"defaultValue": "YardiStage"
		},
		"AH2_YardiStage_properties_typeProperties_userName": {
			"type": "string",
			"defaultValue": "ADF_User"
		},
		"AveryArtisan_Artisan_properties_typeProperties_server": {
			"type": "string",
			"defaultValue": "averyartisan.database.windows.net"
		},
		"AveryArtisan_Artisan_properties_typeProperties_database": {
			"type": "string",
			"defaultValue": "Artisan"
		},
		"AveryArtisan_Artisan_properties_typeProperties_userName": {
			"type": "string",
			"defaultValue": "ADF_User"
		},
		"Broadshield Live API_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://myrus.careshield.com/api/organisation/avery"
		},
		"CQC API_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://api.service.cqc.org.uk"
		},
		"CareBlox_FTP_properties_typeProperties_host": {
			"type": "string",
			"defaultValue": "ftps.accessacloud.com"
		},
		"CareBlox_FTP_properties_typeProperties_userName": {
			"type": "string",
			"defaultValue": "AveryHealthcare_FTPS"
		},
		"Hydra_FTP_properties_typeProperties_host": {
			"type": "string",
			"defaultValue": "45.8.224.76"
		},
		"Hydra_FTP_properties_typeProperties_userName": {
			"type": "string",
			"defaultValue": "radar@averyintranet.co.uk"
		},
		"MCM API_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://care.personcentredsoftware.com/mcm/api/v1/"
		},
		"Myrus_Careshield_UAT_API_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://myrus-uatnew.careshield.com/api/organisation/avery"
		},
		"Radar_DB_properties_typeProperties_server": {
			"type": "string",
			"defaultValue": "integrationserver.radarhealthcare.net"
		},
		"Radar_DB_properties_typeProperties_database": {
			"type": "string",
			"defaultValue": "radar-avery"
		},
		"Radar_DB_properties_typeProperties_userName": {
			"type": "string",
			"defaultValue": "avery-admin"
		},
		"Radar_FTP_properties_typeProperties_host": {
			"type": "string",
			"defaultValue": "integrationserver.radarhealthcare.net"
		},
		"Radar_FTP_properties_typeProperties_userName": {
			"type": "string",
			"defaultValue": "avery_integration"
		},
		"Softworks_API_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://swapi.softworks.com/api/v1//Importer/WebwiseDataExtract"
		},
		"Softworks_API_properties_typeProperties_userName": {
			"type": "string",
			"defaultValue": "AHC23"
		}
	},
	"variables": {
		"factoryId": "[concat('Microsoft.DataFactory/factories/', parameters('factoryName'))]"
	},
	"resources": [
		{
			"name": "[concat(parameters('factoryName'), '/UT_Send_Email')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "Send Email",
						"type": "WebActivity",
						"dependsOn": [
							{
								"activity": "Set EmailTo",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "POST",
							"headers": {},
							"url": "https://prod-03.uksouth.logic.azure.com:443/workflows/0a68dc6512a34064a348fc3ae0b5f808/triggers/When_a_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_a_HTTP_request_is_received%2Frun&sv=1.0&sig=roREdR40o4TL4LlAWfBRXFl4FqFOifD2bKaIC-yucN4",
							"body": {
								"value": "{\n    \"emailTo\": \"@{variables('EmailTo')}\",\n    \"subject\": \"Test Email 7\",\n    \"message\": \"Hello, this is a test email sent by Avery-ADF with a variable used to set the email address.\",\n    \"color\": \"Green\",\n    \"pipelineName\": \"@{pipeline().Pipeline}\",\n    \"pipelineRunId\": \"@{pipeline().RunId}\",\n    \"time\": \"@{utcNow()}\",\n    \n}",
								"type": "Expression"
							}
						}
					},
					{
						"name": "Set EmailTo",
						"type": "SetVariable",
						"dependsOn": [],
						"policy": {
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"variableName": "EmailTo",
							"value": {
								"value": "jon.crockett@averyhealthcare.co.uk",
								"type": "Expression"
							}
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {}
				},
				"variables": {
					"EmailTo": {
						"type": "String"
					}
				},
				"annotations": [],
				"lastPublishTime": "2024-09-18T15:03:11Z"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/UT_Send_Email_Param')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "Send Email",
						"type": "WebActivity",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"method": "POST",
							"headers": {},
							"url": "https://prod-03.uksouth.logic.azure.com:443/workflows/0a68dc6512a34064a348fc3ae0b5f808/triggers/When_a_HTTP_request_is_received/paths/invoke?api-version=2016-10-01&sp=%2Ftriggers%2FWhen_a_HTTP_request_is_received%2Frun&sv=1.0&sig=roREdR40o4TL4LlAWfBRXFl4FqFOifD2bKaIC-yucN4",
							"body": {
								"value": "{\n    \"emailTo\": \"@{pipeline().parameters.EmailTo}\",\n     \"message\": \"@{pipeline().parameters.Message}\",\n    \"colour\": \"@{pipeline().parameters.Colour}\",\n    \"pipelineName\": \"@{pipeline().parameters.PipelineName}\",\n    \"pipelineRunId\": \"@{pipeline().parameters.PipelineRunID}\",\n    \"stepFailed\": \"@{pipeline().parameters.pStepFailed}\",\n    \"time\": \"@{utcNow()}\"    \n}",
								"type": "Expression"
							}
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {}
				},
				"parameters": {
					"EmailTo": {
						"type": "string"
					},
					"Message": {
						"type": "string"
					},
					"Colour": {
						"type": "string"
					},
					"PipelineName": {
						"type": "string"
					},
					"PipelineRunID": {
						"type": "string"
					},
					"pStepFailed": {
						"type": "string"
					}
				},
				"variables": {
					"EmailTo": {
						"type": "String"
					}
				},
				"annotations": [],
				"lastPublishTime": "2024-09-18T15:39:36Z"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/AH1_Avery')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"description": "Avery DB on the AH1 server using the Avery user",
				"annotations": [],
				"type": "AzureSqlDatabase",
				"typeProperties": {
					"connectionString": "[parameters('AH1_Avery_connectionString')]"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/AH2_Agency')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"description": "Agency DB on AH2",
				"annotations": [],
				"type": "AzureSqlDatabase",
				"typeProperties": {
					"server": "[parameters('AH2_Agency_properties_typeProperties_server')]",
					"database": "[parameters('AH2_Agency_properties_typeProperties_database')]",
					"encrypt": "mandatory",
					"trustServerCertificate": false,
					"authenticationType": "SQL",
					"userName": "[parameters('AH2_Agency_properties_typeProperties_userName')]",
					"password": {
						"type": "SecureString",
						"value": "[parameters('AH2_Agency_password')]"
					}
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/AH2_Avery')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"description": "Avery DB on AH2 Server",
				"annotations": [],
				"type": "AzureSqlDatabase",
				"typeProperties": {
					"connectionString": "[parameters('AH2_Avery_connectionString')]"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/AH2_Polestar')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"annotations": [],
				"type": "AzureSqlDatabase",
				"typeProperties": {
					"server": "[parameters('AH2_Polestar_properties_typeProperties_server')]",
					"database": "[parameters('AH2_Polestar_properties_typeProperties_database')]",
					"encrypt": "mandatory",
					"trustServerCertificate": false,
					"authenticationType": "SQL",
					"userName": "[parameters('AH2_Polestar_properties_typeProperties_userName')]",
					"password": {
						"type": "SecureString",
						"value": "[parameters('AH2_Polestar_password')]"
					}
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/AH2_TRANSFORM_DB')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"description": "The Transform_DB on AH2",
				"annotations": [],
				"type": "AzureSqlDatabase",
				"typeProperties": {
					"connectionString": "[parameters('AH2_TRANSFORM_DB_connectionString')]"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/AH2_YardiStage')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"annotations": [],
				"type": "AzureSqlDatabase",
				"typeProperties": {
					"server": "[parameters('AH2_YardiStage_properties_typeProperties_server')]",
					"database": "[parameters('AH2_YardiStage_properties_typeProperties_database')]",
					"encrypt": "mandatory",
					"trustServerCertificate": false,
					"authenticationType": "SQL",
					"userName": "[parameters('AH2_YardiStage_properties_typeProperties_userName')]",
					"password": {
						"type": "SecureString",
						"value": "[parameters('AH2_YardiStage_password')]"
					}
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/AveryArtisan_Artisan')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"description": "Asrtisan DB on AveryArtisan SQL server",
				"annotations": [],
				"type": "AzureSqlDatabase",
				"typeProperties": {
					"server": "[parameters('AveryArtisan_Artisan_properties_typeProperties_server')]",
					"database": "[parameters('AveryArtisan_Artisan_properties_typeProperties_database')]",
					"encrypt": "mandatory",
					"trustServerCertificate": false,
					"authenticationType": "SQL",
					"userName": "[parameters('AveryArtisan_Artisan_properties_typeProperties_userName')]",
					"password": {
						"type": "SecureString",
						"value": "[parameters('AveryArtisan_Artisan_password')]"
					}
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/Broadshield Live API')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"description": "API to Broadshield system for training and compliance data.",
				"annotations": [],
				"type": "RestService",
				"typeProperties": {
					"url": "[parameters('Broadshield Live API_properties_typeProperties_url')]",
					"enableServerCertificateValidation": true,
					"authenticationType": "Anonymous"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/CQC API')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"annotations": [],
				"type": "RestService",
				"typeProperties": {
					"url": "[parameters('CQC API_properties_typeProperties_url')]",
					"enableServerCertificateValidation": true,
					"authenticationType": "Anonymous"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/CareBlox_FTP')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"description": "FTP directory hosted by Access group. Stores copies of SQL back up files for the CareBlox Payroll and Resolve database.",
				"annotations": [],
				"type": "FtpServer",
				"typeProperties": {
					"host": "[parameters('CareBlox_FTP_properties_typeProperties_host')]",
					"port": "5036",
					"enableSsl": true,
					"enableServerCertificateValidation": true,
					"authenticationType": "Basic",
					"userName": "[parameters('CareBlox_FTP_properties_typeProperties_userName')]",
					"password": {
						"type": "SecureString",
						"value": "[parameters('CareBlox_FTP_password')]"
					}
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/Hydra_FTP')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"description": "Hydras FTP Server",
				"annotations": [],
				"type": "FtpServer",
				"typeProperties": {
					"host": "[parameters('Hydra_FTP_properties_typeProperties_host')]",
					"port": 21,
					"enableSsl": true,
					"enableServerCertificateValidation": false,
					"authenticationType": "Basic",
					"userName": "[parameters('Hydra_FTP_properties_typeProperties_userName')]",
					"password": {
						"type": "SecureString",
						"value": "[parameters('Hydra_FTP_password')]"
					}
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/MCM API')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"description": "MCM's API ",
				"annotations": [],
				"type": "RestService",
				"typeProperties": {
					"url": "[parameters('MCM API_properties_typeProperties_url')]",
					"enableServerCertificateValidation": true,
					"authenticationType": "Anonymous"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/Myrus_Careshield_UAT_API')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"annotations": [],
				"type": "RestService",
				"typeProperties": {
					"url": "[parameters('Myrus_Careshield_UAT_API_properties_typeProperties_url')]",
					"enableServerCertificateValidation": true,
					"authenticationType": "Anonymous",
					"authHeaders": {
						"Authorization": {
							"type": "SecureString",
							"value": "**********"
						}
					}
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/PolestarStorageAcc')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"annotations": [],
				"type": "AzureBlobStorage",
				"typeProperties": {
					"connectionString": "[parameters('PolestarStorageAcc_connectionString')]"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/PolestarStorageFileshare')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"annotations": [],
				"type": "AzureFileStorage",
				"typeProperties": {
					"connectionString": "[parameters('PolestarStorageFileshare_connectionString')]",
					"fileShare": "polestar-storage-fileshare"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/Radar_DB')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"description": "Copy of the Radar Database",
				"annotations": [],
				"type": "AzureSqlDatabase",
				"typeProperties": {
					"server": "[parameters('Radar_DB_properties_typeProperties_server')]",
					"database": "[parameters('Radar_DB_properties_typeProperties_database')]",
					"encrypt": "mandatory",
					"trustServerCertificate": false,
					"authenticationType": "SQL",
					"userName": "[parameters('Radar_DB_properties_typeProperties_userName')]",
					"password": {
						"type": "SecureString",
						"value": "[parameters('Radar_DB_password')]"
					}
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/Radar_FTP')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"annotations": [],
				"type": "FtpServer",
				"typeProperties": {
					"host": "[parameters('Radar_FTP_properties_typeProperties_host')]",
					"port": 21,
					"enableSsl": true,
					"enableServerCertificateValidation": true,
					"authenticationType": "Basic",
					"userName": "[parameters('Radar_FTP_properties_typeProperties_userName')]",
					"password": {
						"type": "SecureString",
						"value": "[parameters('Radar_FTP_password')]"
					}
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/Softworks_API')]",
			"type": "Microsoft.DataFactory/factories/linkedServices",
			"apiVersion": "2018-06-01",
			"properties": {
				"description": "Softworks API",
				"annotations": [],
				"type": "RestService",
				"typeProperties": {
					"url": "[parameters('Softworks_API_properties_typeProperties_url')]",
					"enableServerCertificateValidation": true,
					"authenticationType": "Basic",
					"userName": "[parameters('Softworks_API_properties_typeProperties_userName')]",
					"password": {
						"type": "SecureString",
						"value": "[parameters('Softworks_API_password')]"
					}
				}
			},
			"dependsOn": []
		}
	]
}